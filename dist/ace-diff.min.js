/*!
* ace-diff
* @author Ben Keen
* @version 0.1.0
* @date Mar 1st, 2015
* @repo http://github.com/benkeen/ace-diff
*/
!function(a,b){"function"==typeof define&&define.amd?define([],b):"object"==typeof exports?module.exports=b(require()):a.AceDiff=b(a)}(this,function(){"use strict";function a(a,b){var c,e,f,g,h,i,j=parseInt(a.target.getAttribute("data-diff-index"),10),k=this.diffs[j];b===n.LTR?(c=this.editors.left,e=this.editors.right,f=k.leftStartLine,g=k.leftEndLine,h=k.rightStartLine,i=k.rightEndLine):(c=this.editors.right,e=this.editors.left,f=k.rightStartLine,g=k.rightEndLine,h=k.leftStartLine,i=k.leftEndLine);for(var l="",m=f;g>m;m++)l+=d(c,m)+"\n";for(var o="",m=0;h>m;m++)o+=d(e,m)+"\n";for(var p="",q=e.ace.getSession().getLength(),m=i;q>m;m++)p+=d(e,m),q-1>m&&(p+="\n");p=p.replace(/\s*$/,"");var r=e.ace.getSession().getScrollTop();e.ace.getSession().setValue(o+l+p),e.ace.getSession().setScrollTop(parseInt(r)),this.diff()}function b(a,b,d){var e={startLine:0,startChar:0,endLine:0,endChar:0},f=b+d,g=0,h=!1,i=!1;return a.lineLengths.forEach(function(a,c){g+=a,!h&&g>b&&(e.startLine=c,e.startChar=b-g+a,h=!0),!i&&g>=f&&(e.endLine=c,e.endChar=f-g+a,i=!0)}),e.startChar>0&&c(a,e.startLine)===e.startChar&&(e.startLine++,e.startChar=0),0===e.endChar&&e.endLine--,e}function c(a,b){return d(a,b).length}function d(a,b){return a.ace.getSession().doc.getLine(b)}function e(a,b){for(var c=a.ace.getSession().doc.getAllLines(),d=0,e=0,f=0;f<c.length;f++){var g=c[f].length+1;if(e+=g,e>=b){d=f;break}}return d}function f(a,b,c){for(var d=a.ace.getSession().doc.getAllLines(),e=0,f=!1,g=0;g<d.length;g++){var h=d[g].length+1;e+=h;var i=e;if(c&&i--,b===i){f=!0;break}}return f}function g(a){return'<div class="'+a.className+'" style="top:'+a.topOffset+'px" title="'+a.tooltip+'" data-diff-index="'+a.diffIndex+'">'+a.arrowContent+"</div>"}function h(a){$("."+a+" svg").empty()}function i(a){var b=[];a.forEach(function(a,c){if(0===c)return void b.push(a);var d=b[b.length-1];a.leftStartLine-d.leftEndLine<=1&&a.rightStartLine-d.rightEndLine<=1?(b[b.length-1].leftEndLine=a.leftEndLine,b[b.length-1].rightEndLine=a.rightEndLine):b.push(a)});var c=[];return b.forEach(function(a){(a.leftStartLine!==a.leftEndLine||a.rightStartLine!==a.rightEndLine)&&c.push(a)}),c}function j(a){var b=[];return a.forEach(function(a,c){if(0===c)return void b.push(a);b[b.length-1]}),a}function k(a,b,c,d){var e=c-a,f=a+e/2,g="M "+a+" "+b+" C "+f+","+b+" "+f+","+d+" "+c+","+d;return g}function l(a,b,c,d){var e=document.querySelector(a);e.addEventListener(b,function(a){for(var b=e.querySelectorAll(c),f=a.target,g=0,h=b.length;h>g;g++)for(var i=f,j=b[g];i&&i!==e;){if(i===j)return d.call(j,a);i=i.parentNode}})}var m=require("ace/range").Range,n={DIFF_EQUAL:0,DIFF_DELETE:-1,DIFF_INSERT:1,EDITOR_RIGHT:"right",EDITOR_LEFT:"left",RTL:"rtl",LTR:"ltr",SVG_NS:"http://www.w3.org/2000/svg"},o=function(a){this.options={},p(!0,this.options,{element:null,mode:null,lockScrolling:!1,left:{id:"acediff-left-editor",content:null,mode:null,editable:!0,showCopyLTR:!0},right:{id:"acediff-right-editor",content:null,mode:null,editable:!0,showCopyRTL:!0},showDiffs:!0,showConnectors:!0,maxDiffs:5e3,classes:{gutter:"acediff-gutter",diff:"acediff-diff",connector:"acediff-connector",newCodeConnectorLink:"acediff-new-code-connector-copy",newCodeConnectorLinkContent:"&#8594;",deletedCodeConnectorLink:"acediff-deleted-code-connector-copy",deletedCodeConnectorLinkContent:"&#8592;",copyRightContainer:"acediff-copy-right",copyLeftContainer:"acediff-copy-left"}},a),this.editors={left:{ace:ace.edit(this.options.left.id),markers:[],lineLengths:[]},right:{ace:ace.edit(this.options.right.id),markers:[],lineLengths:[]}},this.addEventHandlers(),this.lineHeight=this.editors.left.ace.renderer.lineHeight;var b=$("."+this.options.classes.gutter);this.gutterHeight=b.height(),this.gutterWidth=b.width(),this.editors.left.ace.getSession().setMode(this.getMode(n.EDITOR_LEFT)),this.editors.right.ace.getSession().setMode(this.getMode(n.EDITOR_RIGHT)),this.editors.left.ace.setReadOnly(!this.options.left.editable),this.editors.right.ace.setReadOnly(!this.options.right.editable),this.createCopyContainers(),this.createGutter(),this.diff()};o.prototype.addEventHandlers=function(){var b=this.updateGap.bind(this);this.editors.left.ace.getSession().on("changeScrollTop",function(a){b("left",a)}),this.editors.right.ace.getSession().on("changeScrollTop",function(a){b("right",a)});var c=this.diff.bind(this);this.editors.left.ace.on("change",c),this.editors.right.ace.on("change",c);var d=a.bind(this);this.options.left.showCopyLTR&&l("."+this.options.classes.gutter,"click","."+this.options.classes.newCodeConnectorLink,function(a){d(a,n.LTR)}),this.options.right.showCopyRTL&&l("."+this.options.classes.gutter,"click","."+this.options.classes.deletedCodeConnectorLink,function(a){d(a,n.RTL)})},o.prototype.setOptions=function(a){p(!0,this.options,a)},o.prototype.getLineLengths=function(a){var b=a.ace.getSession().doc.getAllLines(),c=[];return b.forEach(function(a){c.push(a.length+1)}),c},o.prototype.getMode=function(a){var b=this.options.mode;return a===n.EDITOR_LEFT&&null!==this.options.left.mode&&(b=this.options.left.mode),a===n.EDITOR_RIGHT&&null!==this.options.right.mode&&(b=this.options.right.mode),b},o.prototype.showDiff=function(a,b,c,d){var a=this.editors[a];b>c&&(c=b);var e=d+" "+(c>b?"lines":"targetOnly");c--,a.markers.push(a.ace.session.addMarker(new m(b,0,c,1),e,"fullLine"))},o.prototype.diff=function(){var a=new diff_match_patch,b=this.editors.left.ace.getSession().getValue(),c=this.editors.right.ace.getSession().getValue(),d=a.diff_main(c,b);a.diff_cleanupSemantic(d),this.editors.left.lineLengths=this.getLineLengths(this.editors.left),this.editors.right.lineLengths=this.getLineLengths(this.editors.right);var e=[],f={left:0,right:0};d.forEach(function(a){var b=a[0],c=a[1];0!==c.length&&(b===n.DIFF_EQUAL?(f.left+=c.length,f.right+=c.length):b===n.DIFF_DELETE?(e.push(this.computeDiff(n.DIFF_DELETE,f.left,f.right,c)),f.right+=c.length):b===n.DIFF_INSERT&&(e.push(this.computeDiff(n.DIFF_INSERT,f.left,f.right,c)),f.left+=c.length))},this),this.diffs=i(e),this.diffs=j(this.diffs),this.diffs.length>this.options.maxDiffs||(this.clearMarkers(),this.decorate(this.diffs))},o.prototype.getNumDiffs=function(){return this.diffs.length},o.prototype.updateGap=function(a,b){this.options.lockScrolling&&("left"===a&&this.editors.right.ace.getSession().setScrollTop(parseInt(b)||0),"right"===a&&this.editors.left.ace.getSession().setScrollTop(parseInt(b)||0)),this.diff(),this.positionCopyContainers()},o.prototype.clearMarkers=function(){this.editors.left.markers.forEach(function(a){this.editors.left.ace.getSession().removeMarker(a)},this),this.editors.right.markers.forEach(function(a){this.editors.right.ace.getSession().removeMarker(a)},this)},o.prototype.addConnector=function(a,b,c,d,e){var f,g=this.editors.left.ace.getSession().getScrollTop(),h=this.editors.right.ace.getSession().getScrollTop(),i=-1,j=this.gutterWidth+1,l=-1,m=this.gutterWidth+1;if(a===n.LTR){var o=b*this.lineHeight-g+1,p=d*this.lineHeight-h+1,q=c*this.lineHeight-g+1,r=e*this.lineHeight-h+1,s=k(i,o,j,p),t=k(m,r,l,q);f=this.options.classes.connector}else{var o=targetStartLine*this.lineHeight-g+1,p=sourceStartLine*this.lineHeight-h+1,q=targetStartLine*this.lineHeight+targetNumRows*this.lineHeight-g+1,r=sourceEndLine*this.lineHeight+this.lineHeight-h+1,s=k(i,o,j,p),t=k(m,r,l,q);f=this.options.classes.connector}var u="L"+j+","+p+" "+m+","+r,v="L"+l+","+q+" "+i+","+o,w=s+" "+u+" "+t+" "+v,x=$("."+this.options.classes.gutter+" svg")[0],y=document.createElementNS(n.SVG_NS,"path");y.setAttribute("d",w),y.setAttribute("class",f),x.appendChild(y)},o.prototype.addCopyArrows=function(a,b){if(a.leftEndLine>a.leftStartLine){var c=g({className:this.options.classes.newCodeConnectorLink,topOffset:a.leftStartLine*this.lineHeight,tooltip:"Copy to right",diffIndex:b,arrowContent:this.options.classes.newCodeConnectorLinkContent});$("."+this.options.classes.copyRightContainer).append(c)}if(a.rightEndLine>a.rightStartLine){var c=g({className:this.options.classes.deletedCodeConnectorLink,topOffset:a.rightStartLine*this.lineHeight,tooltip:"Copy to left",diffIndex:b,arrowContent:this.options.classes.deletedCodeConnectorLinkContent});$("."+this.options.classes.copyLeftContainer).append(c)}},o.prototype.positionCopyContainers=function(){var a=this.editors.left.ace.getSession().getScrollTop(),b=this.editors.right.ace.getSession().getScrollTop();$("."+this.options.classes.copyRightContainer).css({top:-a+"px"}),$("."+this.options.classes.copyLeftContainer).css({top:-b+"px"})},o.prototype.computeDiff=function(a,d,g,h){var i={};if(a===n.DIFF_INSERT){var j=b(this.editors.left,d,h.length),k=e(this.editors.right,g),l=/^\n/.test(h);f(this.editors.right,g,l)&&k++;var m=c(this.editors.left,j.startLine),o=c(this.editors.right,k);console.log(m);var p=0;o>0&&j.startLine===j.endLine&&j.endChar<m&&p++,i={leftStartLine:j.startLine,leftEndLine:j.endLine+1,rightStartLine:k,rightEndLine:k+p}}else{var j=b(this.editors.right,g,h.length),k=e(this.editors.left,d);f(this.editors.left,d)&&k++;var p=0,m=c(this.editors.right,j.startLine),o=c(this.editors.left,k);(j.startChar>0||j.startLine==j.endLine&&j.endChar<m||0===o)&&p++,i={leftStartLine:k,leftEndLine:k+p,rightStartLine:j.startLine,rightEndLine:j.endLine+1}}return i},o.prototype.createGutter=function(){var a=this.editors.left.ace.getSession().getLength()*this.lineHeight,b=this.editors.right.ace.getSession().getLength()*this.lineHeight,c=Math.max(a,b,this.gutterHeight),d=document.createElementNS(n.SVG_NS,"svg");d.setAttribute("width",this.gutterWidth),d.setAttribute("height",c),$("."+this.options.classes.gutter).append(d)},o.prototype.createCopyContainers=function(){$("."+this.options.classes.gutter).append('<div class="'+this.options.classes.copyRightContainer+'"></div>').append('<div class="'+this.options.classes.copyLeftContainer+'"></div>')},o.prototype.clearArrows=function(){$("."+this.options.classes.copyLeftContainer+", ."+this.options.classes.copyRightContainer).empty()},o.prototype.decorate=function(a){h(this.options.classes.gutter),this.clearArrows(),a.forEach(function(a,b){this.options.showDiffs&&(this.showDiff(n.EDITOR_LEFT,a.leftStartLine,a.leftEndLine,this.options.classes.diff),this.showDiff(n.EDITOR_RIGHT,a.rightStartLine,a.rightEndLine,this.options.classes.diff),this.options.showConnectors&&this.addConnector(n.LTR,a.leftStartLine,a.leftEndLine,a.rightStartLine,a.rightEndLine),this.addCopyArrows(a,b))},this)};var p=function(){var a,b,c,d,e,f,g=arguments[0]||{},h=1,i=arguments.length,j=!1,k=Object.prototype.toString,l=Object.prototype.hasOwnProperty,m={"[object Boolean]":"boolean","[object Number]":"number","[object String]":"string","[object Function]":"function","[object Array]":"array","[object Date]":"date","[object RegExp]":"regexp","[object Object]":"object"},n={isFunction:function(a){return"function"===n.type(a)},isArray:Array.isArray||function(a){return"array"===n.type(a)},isWindow:function(a){return null!==a&&a===a.window},isNumeric:function(a){return!isNaN(parseFloat(a))&&isFinite(a)},type:function(a){return null===a?String(a):m[k.call(a)]||"object"},isPlainObject:function(a){if(!a||"object"!==n.type(a)||a.nodeType)return!1;try{if(a.constructor&&!l.call(a,"constructor")&&!l.call(a.constructor.prototype,"isPrototypeOf"))return!1}catch(b){return!1}var c;for(c in a);return void 0===c||l.call(a,c)}};for("boolean"==typeof g&&(j=g,g=arguments[1]||{},h=2),"object"==typeof g||n.isFunction(g)||(g={}),i===h&&(g=this,--h),h;i>h;h++)if(null!==(a=arguments[h]))for(b in a)c=g[b],d=a[b],g!==d&&(j&&d&&(n.isPlainObject(d)||(e=n.isArray(d)))?(e?(e=!1,f=c&&n.isArray(c)?c:[]):f=c&&n.isPlainObject(c)?c:{},g[b]=p(j,f,d)):void 0!==d&&(g[b]=d));return g};return o});